<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mensaje Builder</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="container">
        <div class="input-section">
            <div class="logo-container">
                <img src="/static/imagenes/delancer.png" alt="Delancer Logo" class="logo">
            </div>
            <h2>Enviar mensaje a cliente</h2>
            <form id="messageForm">
                <!-- Selector de Idiomas -->
                <div class="form-group">
                    <label for="language">Idioma:</label>
                    <select id="language" required>
                        <option value="">Seleccionar idioma...</option>
                    </select>
                </div>

                <!-- Selector de Departamentos -->
                <div class="form-group">
                    <label for="departamento">Departamento:</label>
                    <select id="departamento" required>
                        <option value="">Seleccionar departamento...</option>
                    </select>
                </div>

                <!-- Selector de Templates -->
                <div class="form-group">
                    <label for="template">Template:</label>
                    <select id="template" required disabled>
                        <option value="">Seleccionar template...</option>
                    </select>
                </div>

                <!-- Campo de Número de Teléfono -->
                <div class="form-group">
                    <label for="phoneNumber">Número de destino:</label>
                    <input type="tel" id="phoneNumber" required 
                           pattern="[0-9]{10}" 
                           placeholder="Ingrese número (10 dígitos)">
                </div>

                <button type="submit">Enviar Mensaje</button>
            </form>
        </div>

        <!-- Sección de Vista Previa -->
        <div class="preview-section">
            <h2>Preview del Mensaje</h2>
            <div id="messagePreview"></div>
        </div>
    </div>

    <!-- Lógica de Carga de Datos y Envío -->
    <script>
        $(document).ready(function() {
            // Cargar idiomas al iniciar
            fetch('/api/idiomas')
                .then(response => response.json())
                .then(data => {
                    const languageSelect = $('#language');
                    data.forEach(lang => {
                        languageSelect.append(`<option value="${lang.idioma}">${lang.nombre}</option>`);
                    });
                });

            // Reiniciar departamentos al cambiar idioma
            $('#language').change(function() {
                $('#departamento').val('').change(); // Reinicia el departamento
            });

            // Cargar departamentos y templates
            $('#departamento').change(function() {
                const idioma = $('#language').val();
                const departamentoId = $(this).val();
                const templateSelect = $('#template');

                // Limpiar y deshabilitar selector de templates
                templateSelect.prop('disabled', true);
                templateSelect.html('<option value="">Seleccionar template...</option>');

                // Validar que haya idioma y departamento seleccionados
                if (idioma && departamentoId) {
                    fetch(`/api/templates?idioma=${idioma}&departamento_id=${departamentoId}`)
                        .then(response => response.json())
                        .then(data => {
                            // Agregar las opciones de templates
                            data.forEach(template => {
                                templateSelect.append(`<option value="${template.id}">${template.mensaje}</option>`);
                            });
                            templateSelect.prop('disabled', false);
                        });
                }
            });

            // Actualizar la vista previa del mensaje
            function updatePreview() {
                const templateId = $('#template').val();
                const phoneNumber = $('#phoneNumber').val();

                if (templateId) {
                    const message = $('#template option:selected').text();
                    const preview = `Para: ${phoneNumber || "Número no ingresado"}\nMensaje: ${message}`;
                    $('#messagePreview').text(preview);
                }
            }

            $('#template, #phoneNumber').on('change input', updatePreview);

            // Enviar formulario
            $('#messageForm').on('submit', function(e) {
                e.preventDefault();

                const formData = {
                    idioma: $('#language').val(),
                    departamento_id: $('#departamento').val(),
                    template_id: $('#template').val(),
                    phoneNumber: $('#phoneNumber').val(),
                    message: $('#template option:selected').text()
                };

                fetch('/api/send-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    alert('Mensaje enviado exitosamente');
                })
                .catch(error => {
                    alert('Error al enviar el mensaje');
                    console.error('Error:', error);
                });
            });
        });
    </script>
</body>
</html>
